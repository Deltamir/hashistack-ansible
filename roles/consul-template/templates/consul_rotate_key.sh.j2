#!/usr/bin/env bash


echo "==========BEGIN GOSSIP KEY ROTATION=========="

# Setup Consul address info
export CONSUL_HTTP_ADDR="http://{{ inventory_hostname }}:8500"

# The new key will be in a file generated by consul-template
# the script retrieves the key from the file
NEW_KEY=`cat /opt/consul/gossip/gossip.key | sed -e '/^$/d'`

# Install the key
consul keyring -install ${NEW_KEY}

# Set as primary
consul keyring -use ${NEW_KEY}

# Retrieve all keys used by Consul
KEYS=`curl -s ${CONSUL_HTTP_ADDR}/v1/operator/keyring`

ALL_KEYS=`echo ${KEYS} | jq -r '.[].Keys| to_entries[].key' | sort | uniq`

for i in `echo ${ALL_KEYS}`; do
  if [ $i != ${NEW_KEY} ] ; then
    consul keyring -remove $i
  fi
done

echo "==> Writing next gossip encryption key to vault..."

curl  --header "X-Vault-Token: {{ root_token }}" --request POST --data "{\"key\": \"$(consul keygen)\", \"ttl\": \"{{ consul_template_gossip_key_ttl }}\"}" -k  http://{{ inventory_hostname }}:8200/v1/kv/consul/config/encryption

echo "==> Done at $(date). Waiting for next ttl."


echo "==========END GOSSIP KEY ROTATION=========="
